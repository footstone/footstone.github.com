---
layout: post
title: 基于OWASP Top10的安全编码规范
---

###基于OWASP Top10的安全编码规范

因为企业内网应用的开发背景，我（及部门团队）在开发过程中，基本没有考虑过安全相关的问题-_-。安全问题琐碎零散，通过OWASP Top10来梳理或许算得上是一种比较清晰明确的方式。根据以往经验及收集到的材料，整理了一份安全编码规范。

#### 一、注入

1. 不使用java.sql.Statement执行SQL，而是使用java.sql.PreparedStatement。
2. 对SQL参数值中的单引号要检查并过滤。
3. 对WEB请求或接口参数中的select、update、delete、truncate、drop等非法字符作拦截过滤。
4. 禁止向外暴露数据库等信息，如异常处理等，具体参考防止信息泄露章节。
5. 基于最小权限原则，减少数据库用户操作权限。
6. 使用相对路径Canonical Path，避免文件路径含有../等字符。如：
	```
File file = new File(str);
file.getAbsolutePath();//no
file.getCanonicalPath();//yes
	```
	
7. 尽量避免使用Runtime.getRuntime().exec()，如必须使用，则尽量避免传入动态参数，并注意检查特定字符。


#### 二、认证和会话管理

1. 在用户连续登陆失败的情况下，需要限制其请求，如增加验证码、锁定账号等。
3. 支持限定用户登陆的IP、MAC绑定功能，限定登陆范围。
4. 用户登出或浏览器关闭时，即立刻注销会话，删除与该会话相关的所有临时数据，并及时清理认证票据。
5. 会话时间尽量设短。	
6. Cookie票据加密存储，并设置HttpOnly、Secure属性。
7. 禁止明文存储密码。
8. 尽量减少在HttpSession对象中的存储数据。
9. 登陆成功后重新建立sessionId。
10. 用户会话中的sessionId禁止作为参数传递。


#### 三、XSS

* 对HTTP请求进行检查

    因为前台输入的字符串具有很大的随意性，且基于js的输入校验很容易被突破，所以必须在server端进行输入校验。
	* 校验原则：
	1) 基于白名单原则的校验，对于不符合格式的一律拒绝。
	2) 基于正确格式的校验，对于不符合格式的，拒绝或替换非法字符。

	* 对HttpServletRequest参数值要进行校验，校验范围包括：

```
	request.getParameter
	request.getQueryString
	request.getHeader
	request.getCookies
```

* 对HTTP响应进行编码

如果仅仅对请求进行处理，而不处理响应，那么通过其他渠道进入到系统的恶意脚本还是有可能被执行，所以必须对输出也要处理。具体方式是采用HTML编码方式对危险字符进行编码，包括：

* JSP页面中使用JSTL标签输出以避免XSS

#### 四、不安全的直接对象引用

一个已经授权的用户，通过更改访问时的一个参数，从而访问到了原本其并没有得到授权的对象。Web应用往往在生成Web页面时会用它的真实名字，且并不会对所有的目标对象访问时来检查用户权限，所以这就造成了不安全的对象直接引用的漏洞。例如开发者将数据库记录主键ID作为URL的一部分暴露给用户，可能被恶意用户利用进行恶意操作

* 使用基于用户或者会话的间接对象引用
	
这样能防止攻击者直接攻击未授权资源。例如，一个下拉列表包含6个授权给当前用户的资源，它可以使用数字1-6来指示哪个是用户选择的值，而不是使用资源的数据库关键字来表示。在服务器端，应用程序需要将每个用户的间接引用映射到实际的数据库关键字。

* ID稀疏
	
不使用自增ID，而使用随机字符串作数据记录ID的方式，减少被用户恶意操纵的可能。如：

```
http://www.xxx.com/getCustomerInfo.jsp?id=xcdfuwolqpox
```

* 检查访问

任何来自不可信源的直接对象引用都必须通过访问权限检查，确保该用户对请求的对象有访问权限。

#### 五、安全配置错误

这个问题可能存在于Web应用的各个层次，譬如平台、Web服务器、应用服务器，系统框架，甚至是代码中。开发人员需要和网络管理人员共同确保所有层次都合理配置，如错误的安全配置，缺省用户是否存在，不必要的服务等等。

1. 主机配置时，通过统一的脚本配置环境，关闭ip6tables\NetworkManager等不必要的服务。
2. 安装中间件时，关闭资源目录的列目录功能。
3. 对于服务器，数据库等，开发、测试、生产等各环境下均使用不同的账号密码，并定期修改密码。
4. 对于操作系统、中间件、第三方软件产品等，及时安装最新补丁。
5. 数据库、FTP等资源账号密码不得明文存储。



#### *链接*

[OWASP Top10 (2013)
](http://www.owasp.org.cn/owasp-project/download/OWASPTop102013V1.2.pdf)

[OWASP-ESAPI-JAVA](https://code.google.com/p/owasp-esapi-java/)
